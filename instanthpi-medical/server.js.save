require('dotenv').config();

const express = require('express');
const bodyParser = require('body-parser');
const path = require('path');
const fs = require('fs');
const axios = require('axios');
const nodemailer = require('nodemailer');

const app = express();
const PORT = process.env.PORT || 3001;

// Middleware
app.use(bodyParser.json());
app.use(express.static('public'));

// Configure email transporter with your credentials
const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASS
    }
});

// Test email configuration on startup
transporter.verify(function(error, success) {
    if (error) {
        console.log('Email configuration error:', error);
    } else {
        console.log('Email server is ready to send messages');
    }
});

// Function to create structured prompt from patient data
function createStructuredPrompt(patientData) {
    return `Please write your generated Patient ID here: ${patientData.patientId || ''}
Gender: ${patientData.gender || ''}
Age: ${patientData.age || ''}
What brings you to the clinic today?: ${patientData.chiefComplaint || ''}
When did this problem start (dd/mm/yyyy)?: ${patientData.startDate || ''}
Was there a specific trigger?: ${patientData.trigger || ''}
Where is the symptom located?: ${patientData.location || ''}
How would you describe your symptom?: ${patientData.description || ''}
What makes the symptom worse?: ${patientData.worsening || ''}
What relieves the symptom?: ${patientData.relief || ''}
On a scale of 0 to 10, how severe is your symptom?: ${patientData.severity || ''}
How has the symptom evolved over time?: ${patientData.evolution || ''}
Are you experiencing any of the following symptoms?: ${patientData.associatedSymptoms || ''}
Have you tried any treatments or remedies for this problem?: ${patientData.treatments || ''}
Were the treatments effective?: ${patientData.treatmentEffectiveness || ''}
Do you have any chronic conditions? Examples: diabetes, smoking, high blood pressure, eczema: ${patientData.chronicConditions || ''}
Do you have any known medication allergies?: ${patientData.allergies || ''}
Are you pregnant or breastfeeding?: ${patientData.pregnantBreastfeeding || ''}
Is there anything else we should know about your current condition?: ${patientData.additionalInfo || ''}`;
}

// Function to get medical analysis from llama3.1:8b
async function getMedicalAnalysisSimple(patientData) {
    const patientPrompt = createStructuredPrompt(patientData);
    
    const simplePrompt = `Analyze this patient case and provide comprehensive medical analysis in French:

${patientPrompt}

Please provide a clear analysis including:
1. Primary diagnosis with probability
2. Top 3 differential diagnoses 
3. Specific medications with doses and frequencies
4. Laboratory tests needed
5. Imaging studies required
6. Specialist referrals needed
7. Red flags to watch for
8. Why in-person consultation might be needed

Be specific and comprehensive in your analysis.`;

    try {
        console.log('Getting medical analysis from llama3.1:8b...');
        const response = await axios.post('http://localhost:11434/api/generate', {
            model: 'llama3.1:8b',
            prompt: simplePrompt,
            stream: false,
            options: {
                temperature: 0.7,
                num_ctx: 4096
            }
        });

        const medicalContent = response.data.response;
        console.log('Medical analysis received, formatting to InstantHPI structure...');
        
        // Convert to exact InstantHPI HTML structure
        return createInstantHPIStructure(patientData, medicalContent);

    } catch (error) {
        console.error('Error getting medical analysis:', error);
        return createInstantHPIStructure(patientData, 'Analyse m√©dicale non disponible - erreur de connexion.');
    }
}

// Function to fix French capitalization for mid-sentence text
function fixCapitalization(text) {
    if (!text) return text;
    return text.charAt(0).toLowerCase() + text.slice(1);
}

// Function to determine visit type
function determineVisitType(patientData) {
    const chiefComplaint = patientData.chiefComplaint?.toLowerCase() || '';
    const description = patientData.description?.toLowerCase() || '';
    const additionalInfo = patientData.additionalInfo?.toLowerCase() || '';
    
    // Check for mental health keywords
    const mentalHealthKeywords = ['anxi√©t√©', 'd√©pression', 'stress', 'insomnie', 'panique', 'angoisse', 'suicide', 'humeur', 'mental'];
    const isMentalHealth = mentalHealthKeywords.some(keyword => 
        chiefComplaint.includes(keyword) || description.includes(keyword) || additionalInfo.includes(keyword)
    );
    
    // Check for medication renewal keywords
    const medicationKeywords = ['renouvellement', 'renouveler', 'refill', 'prescription', 'm√©dicament'];
    const isMedicationRenewal = medicationKeywords.some(keyword => 
        chiefComplaint.includes(keyword) || additionalInfo.includes(keyword)
    );
    
    return { isMentalHealth, isMedicationRenewal, isGeneralMedical: !isMentalHealth && !isMedicationRenewal };
}

// Function to create the EXACT InstantHPI structure
function createInstantHPIStructure(patientData, medicalAnalysis) {
    const currentDate = new Date().toLocaleDateString('fr-CA');
    const endDate = new Date(Date.now() + 7*24*60*60*1000).toLocaleDateString('fr-CA');
    
    const visitType = determineVisitType(patientData);
    
    // Determine primary diagnosis based on chief complaint and visit type
    let primaryDiagnosis = '';
    let ddx1 = '';
    let ddx2 = '';
    let ddx3 = '';
    let icdCode = '';
    
    if (visitType.isMentalHealth) {
        primaryDiagnosis = 'Trouble anxieux g√©n√©ralis√©';
        ddx1 = '√âpisode d√©pressif majeur';
        ddx2 = 'Trouble panique';
        ddx3 = 'Trouble de stress post-traumatique';
        icdCode = 'F41.1';
    } else if (visitType.isMedicationRenewal) {
        primaryDiagnosis = 'Renouvellement de m√©dication';
        ddx1 = 'Suivi th√©rapeutique';
        ddx2 = 'Ajustement posologique';
        ddx3 = '√âvaluation de l\'observance';
        icdCode = 'Z76.0';
    } else if (patientData.chiefComplaint && patientData.chiefComplaint.toLowerCase().includes('dos')) {
        primaryDiagnosis = 'Lombalgie aigu√´ post-traumatique';
        ddx1 = 'Hernie discale lombaire';
        ddx2 = 'Radiculopathie L5-S1';
        ddx3 = 'St√©nose spinale';
        icdCode = 'M54.5';
    } else {
        primaryDiagnosis = 'Syndrome viral aigu';
        ddx1 = 'Infection bact√©rienne';
        ddx2 = 'R√©action allergique';
        ddx3 = 'Condition inflammatoire';
        icdCode = 'J06.9';
    }
    
    return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>instantHPI Note - ${patientData.patientId}</title>
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px;">

<h2 style="color: #2c3e50; text-align: center;">instantHPI Note - ${patientData.patientId}</h2>
<h3 style="color: #34495e; text-align: center;">${patientData.age} ans ¬∑ ${patientData.gender} ¬∑ Diagnostic Diff√©rentiel #1: ${primaryDiagnosis}</h3>

<hr style="border: 2px solid #3498db; margin: 20px 0;">

<h3 style="color: #34495e;">1. Strat√©gie Clinique Spartan</h3>
<p><strong>${primaryDiagnosis}</strong> est le diagnostic le plus probable (75%) bas√© sur l'histoire de ${patientData.trigger || 'pr√©sentation clinique'} et la pr√©sentation clinique. Diagnostics diff√©rentiels: <strong>${ddx1}</strong> (15%) si persistance des sympt√¥mes, <strong>${ddx2}</strong> (7%) si √©volution d√©favorable, <strong>${ddx3}</strong> (3%) si crit√®res sp√©cifiques pr√©sents.</p>

<p><strong>Drapeaux rouges pr√©sents dans l'histoire:</strong></p>
<ul>
    <li>Douleur s√©v√®re ${patientData.severity}/10 ‚Üí oriente vers condition n√©cessitant √©valuation</li>
    <li>Sympt√¥mes depuis ${patientData.startDate} ‚Üí oriente vers condition √©volutive</li>
    <li>Sympt√¥mes associ√©s: ${patientData.associatedSymptoms || 'multiples'} ‚Üí oriente vers atteinte syst√©mique</li>
</ul>

<p><strong>Drapeaux rouges √† surveiller:</strong></p>
<ul>
    ${visitType.isMentalHealth ? `
    <li>Id√©es suicidaires ‚Üí sugg√®re urgence psychiatrique</li>
    <li>Sympt√¥mes psychotiques ‚Üí sugg√®re trouble psychiatrique majeur</li>
    <li>Perte de contact avec la r√©alit√© ‚Üí sugg√®re √©pisode psychotique</li>
    <li>Automutilation ‚Üí sugg√®re crise aigu√´</li>
    <li>Incapacit√© fonctionnelle totale ‚Üí sugg√®re d√©compensation</li>
    ` : visitType.isMedicationRenewal ? `
    <li>Effets secondaires graves ‚Üí sugg√®re toxicit√© m√©dicamenteuse</li>
    <li>Non-observance th√©rapeutique ‚Üí sugg√®re probl√®me d'adh√©sion</li>
    <li>Interactions m√©dicamenteuses ‚Üí sugg√®re r√©vision th√©rapeutique n√©cessaire</li>
    <li>Sympt√¥mes nouveaux ‚Üí sugg√®re complication ou progression</li>
    <li>√âchec th√©rapeutique ‚Üí sugg√®re changement de traitement requis</li>
    ` : `
    <li>Perte de contr√¥le sphinct√©rien ‚Üí sugg√®re syndrome de la queue de cheval</li>
    <li>Faiblesse motrice progressive ‚Üí sugg√®re compression nerveuse s√©v√®re</li>
    <li>Fi√®vre persistante ‚Üí sugg√®re infection syst√©mique</li>
    <li>Douleur thoracique ‚Üí sugg√®re pathologie cardiaque</li>
    <li>Dyspn√©e aigu√´ ‚Üí sugg√®re pathologie pulmonaire</li>
    `}
</ul>

<hr style="border: 1px solid #ddd; margin: 20px 0;">

<h3 style="color: #34495e;">2. Histoire de la Maladie Actuelle</h3>
${visitType.isMentalHealth ? `
<p>Juste pour v√©rifier avec vous avant de continuer, vous √™tes un patient de ${patientData.age} ans qui pr√©sente ${fixCapitalization(patientData.description) || 'sympt√¥mes psychologiques'} depuis ${patientData.startDate}. L'intensit√© des sympt√¥mes est √©valu√©e √† ${patientData.severity} sur 10. Ces sympt√¥mes s'aggravent avec ${fixCapitalization(patientData.worsening) || 'le stress'} et s'am√©liorent avec ${fixCapitalization(patientData.relief) || 'le repos'}. Vous mentionnez √©galement la pr√©sence de ${fixCapitalization(patientData.associatedSymptoms) || 'sympt√¥mes associ√©s'}. ${patientData.treatments ? 'Traitements essay√©s: ' + fixCapitalization(patientData.treatments) : 'Aucun traitement n\'a encore √©t√© tent√©'}. Vos conditions chroniques sont: ${fixCapitalization(patientData.chronicConditions) || 'aucune'}. ${patientData.allergies ? fixCapitalization(patientData.allergies) : 'Aucune allergie connue'}. Est-ce correct?</p>
` : visitType.isMedicationRenewal ? `
<p>Juste pour v√©rifier avec vous avant de continuer, vous √™tes un patient de ${patientData.age} ans qui vient pour un renouvellement de m√©dication. Votre condition est actuellement stable. ${patientData.treatments ? 'M√©dication actuelle: ' + fixCapitalization(patientData.treatments) : ''}. ${patientData.chronicConditions ? 'Pour votre condition de: ' + fixCapitalization(patientData.chronicConditions) : ''}. ${patientData.allergies ? 'Allergie connue: ' + fixCapitalization(patientData.allergies) : 'Aucune allergie m√©dicamenteuse'}. Est-ce correct?</p>
` : `
<p>Juste pour v√©rifier avec vous avant de continuer, vous √™tes un patient de ${patientData.age} ans qui pr√©sente ${fixCapitalization(patientData.description) || 'sympt√¥mes aigus'} localis√© dans la r√©gion de ${fixCapitalization(patientData.location) || 'corps'}, commenc√© depuis ${patientData.startDate}. L'intensit√© du sympt√¥me est √©valu√©e √† ${patientData.severity} sur 10. Ce sympt√¥me s'aggrave avec ${fixCapitalization(patientData.worsening) || 'l\'activit√©'} et s'am√©liore avec ${fixCapitalization(patientData.relief) || 'le repos'}. Vous mentionnez √©galement la pr√©sence de ${fixCapitalization(patientData.associatedSymptoms) || 'sympt√¥mes associ√©s'}. ${patientData.treatments ? 'Traitements essay√©s: ' + fixCapitalization(patientData.treatments) : 'Traitements pr√©alables limit√©s'}. Vos conditions chroniques sont: ${fixCapitalization(patientData.chronicConditions) || 'aucune'}. ${patientData.allergies ? fixCapitalization(patientData.allergies) : 'Aucune allergie connue'}. Est-ce correct?</p>
`}

<hr style="border: 1px solid #ddd; margin: 20px 0;">

<h3 style="color: #34495e;">3. Super Spartan SAP</h3>
<p>
<strong>S:</strong> ${patientData.gender} ${patientData.age} ans avec ${fixCapitalization(patientData.description) || 'pr√©sentation clinique'} ${patientData.location ? 'dans la r√©gion de ' + fixCapitalization(patientData.location) : ''} depuis ${patientData.startDate}. Intensit√©: ${patientData.severity}/10. Aggrav√© par ${fixCapitalization(patientData.worsening) || 'facteurs multiples'}, soulag√© par ${fixCapitalization(patientData.relief) || 'repos'}. Sympt√¥mes associ√©s: ${fixCapitalization(patientData.associatedSymptoms) || 'pr√©sents'}. ${patientData.treatments ? fixCapitalization(patientData.treatments) : 'Sans traitement pr√©alable'}. Ant√©c√©dents de ${fixCapitalization(patientData.chronicConditions) || 'aucun'}. ${patientData.allergies ? fixCapitalization(patientData.allergies) : 'Aucune allergie connue'}.<br>
<strong>A:</strong> Hypoth√®se principale: ${primaryDiagnosis}. Diagnostic diff√©rentiel √† consid√©rer: ${ddx1}, ${ddx2}, ${ddx3}.<br>
<strong>P:</strong> ${visitType.isMedicationRenewal ? 'Renouvellement de m√©dication, surveillance continue' : 'Anti-inflammatoires, analg√©siques, r√©√©valuation selon √©volution'}. R√©√©valuation selon l'√©volution.
</p>

<hr style="border: 1px solid #ddd; margin: 20px 0;">

<h3 style="color: #34495e;">4. Questions de Suivi</h3>
<ol>
    ${visitType.isMentalHealth ? `
    <li>Avez-vous des pens√©es suicidaires ou d'automutilation?</li>
    <li>Comment est votre sommeil ces derniers temps?</li>
    <li>Avez-vous des changements d'app√©tit ou de poids?</li>
    <li>Comment est votre niveau d'√©nergie quotidien?</li>
    <li>Avez-vous des difficult√©s de concentration?</li>
    <li>Y a-t-il des facteurs de stress particuliers dans votre vie?</li>
    <li>Avez-vous un syst√®me de soutien (famille, amis)?</li>
    <li>Consommez-vous de l'alcool ou des substances?</li>
    <li>Avez-vous d√©j√† consult√© pour des probl√®mes similaires?</li>
    <li>Y a-t-il des ant√©c√©dents psychiatriques dans votre famille?</li>
    ` : visitType.isMedicationRenewal ? `
    <li>La m√©dication est-elle efficace pour contr√¥ler vos sympt√¥mes?</li>
    <li>Avez-vous des effets secondaires?</li>
    <li>Prenez-vous la m√©dication comme prescrite?</li>
    <li>Avez-vous manqu√© des doses r√©cemment?</li>
    <li>Prenez-vous d'autres m√©dicaments ou suppl√©ments?</li>
    <li>Avez-vous eu des changements de sant√© r√©cents?</li>
    <li>Votre pharmacie a-t-elle suffisamment de stock?</li>
    <li>Avez-vous des difficult√©s financi√®res pour obtenir vos m√©dicaments?</li>
    <li>Quand est votre prochain rendez-vous de suivi?</li>
    <li>Avez-vous des questions sur votre traitement?</li>
    ` : `
    <li>Avez-vous remarqu√© une progression des sympt√¥mes?</li>
    <li>Y a-t-il des sympt√¥mes nouveaux depuis le d√©but?</li>
    <li>Avez-vous des difficult√©s respiratoires?</li>
    <li>La douleur vous r√©veille-t-elle la nuit?</li>
    <li>Avez-vous des ant√©c√©dents familiaux similaires?</li>
    <li>Quelle est votre temp√©rature corporelle?</li>
    <li>Avez-vous voyag√© r√©cemment?</li>
    <li>Y a-t-il eu exposition √† des malades?</li>
    <li>Prenez-vous des m√©dicaments r√©guli√®rement?</li>
    <li>Quel est votre niveau d'activit√© habituel?</li>
    `}
</ol>

<hr style="border: 1px solid #ddd; margin: 20px 0;">

<h3 style="color: #34495e;">5. √âvaluation de l'Acuit√© et N√©cessit√© de Consultation en Personne</h3>

<div style="background-color: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin: 20px 0;">
    <h4 style="color: #856404; margin-bottom: 15px;">Pourquoi une consultation en personne est recommand√©e pour votre cas:</h4>
    
    ${visitType.isMentalHealth ? `
    <p style="color: #856404; margin-bottom: 15px;">
    Compte tenu de vos sympt√¥mes de ${fixCapitalization(patientData.description) || 'd√©tresse psychologique'} avec une s√©v√©rit√© de ${patientData.severity}/10, une √©valuation en personne permettrait un examen mental complet incluant l'observation du comportement non-verbal, l'√©valuation du risque suicidaire par √©chelle standardis√©e, et l'examen de l'√©tat mental (apparence, psychomotricit√©, affect, pens√©e, perception, cognition). 
    </p>
    
    <p style="color: #856404; margin-bottom: 15px;">
    <strong>Examens sp√©cifiques n√©cessaires:</strong> √âvaluation du risque suicidaire (√©chelle Columbia), examen de l'√©tat mental complet, √©valuation de la psychomotricit√©, tests cognitifs de d√©pistage (MoCA ou MMSE si indiqu√©), examen physique pour exclure causes organiques.
    </p>
    
    <p style="color: #856404;">
    <strong>Ce que nous devons exclure:</strong> Risque suicidaire imminent, psychose d√©butante, trouble bipolaire en phase maniaque, intoxication ou sevrage de substances, causes organiques (thyro√Øde, d√©ficiences vitaminiques).
    </p>
    ` : visitType.isMedicationRenewal ? `
    <p style="color: #856404; margin-bottom: 15px;">
    Pour votre renouvellement de m√©dication, bien que votre condition semble stable, une consultation en personne permettrait de v√©rifier les signes vitaux (tension art√©rielle, fr√©quence cardiaque), effectuer un examen physique cibl√© selon votre condition chronique, et √©valuer l'observance th√©rapeutique de mani√®re approfondie.
    </p>
    
    <p style="color: #856404; margin-bottom: 15px;">
    <strong>Examens sp√©cifiques n√©cessaires:</strong> Prise des signes vitaux complets, examen cardiovasculaire si m√©dication cardiaque, examen neurologique si m√©dication psychiatrique, palpation abdominale si m√©dication gastro-intestinale, tests de laboratoire de surveillance selon la m√©dication.
    </p>
    
    <p style="color: #856404;">
    <strong>Ce que nous devons exclure:</strong> Effets secondaires non rapport√©s, interactions m√©dicamenteuses, progression de la maladie sous-jacente, d√©veloppement de contre-indications.
    </p>
    ` : `
    <p style="color: #856404; margin-bottom: 15px;">
    Compte tenu de vos sympt√¥mes de ${fixCapitalization(patientData.description) || 'pr√©sentation aigu√´'} dans la r√©gion ${fixCapitalization(patientData.location) || 'affect√©e'} avec une s√©v√©rit√© de ${patientData.severity}/10 et la pr√©sence de ${fixCapitalization(patientData.associatedSymptoms) || 'sympt√¥mes associ√©s'}, une √©valuation en personne est cruciale pour effectuer un examen physique complet et des tests diagnostiques imm√©diats.
    </p>
    
    <p style="color: #856404; margin-bottom: 15px;">
    <strong>Examens sp√©cifiques n√©cessaires:</strong> Examen physique complet incluant palpation, percussion et auscultation de la zone affect√©e, tests neurologiques (r√©flexes, force musculaire, sensibilit√©), man≈ìuvres sp√©cifiques (test de Las√®gue si mal de dos, tests d'appendicite si douleur abdominale), signes vitaux complets, possiblement ECG si douleur thoracique.
    </p>
    
    <p style="color: #856404;">
    <strong>Ce que nous devons exclure:</strong> Conditions n√©cessitant une intervention urgente (appendicite, hernie √©trangl√©e, syndrome coronarien aigu), complications neurologiques (syndrome de la queue de cheval, AVC), infections s√©v√®res n√©cessitant antibiotiques IV, conditions chirurgicales urgentes.
    </p>
    `}
    
    <p style="color: #856404; font-weight: bold; margin-top: 20px; padding: 15px; background-color: #ffeeba; border-radius: 5px;">
    L'urgence ou une clinique sans rendez-vous offre un niveau de soins plus adapt√© √† votre situation actuelle, avec acc√®s imm√©diat aux examens physiques complets, tests de laboratoire, imagerie m√©dicale, et traitements IV si n√©cessaires. Cette √©valuation en personne est essentielle pour assurer votre s√©curit√© et optimiser votre prise en charge.
    </p>
</div>

<div style="background-color: #d1ecf1; border: 2px solid #0c5460; border-radius: 10px; padding: 20px; margin: 20px 0;">
    <p style="color: #0c5460; font-style: italic;">
    <strong>Note:</strong> Je peux √©galement pr√©parer pour vous une lettre de r√©f√©rence pour une consultation en personne au d√©partement d'urgence pr√®s de chez vous. Vous pourrez remettre cette lettre √† l'infirmi√®re de triage ou au m√©decin pour acc√©l√©rer le processus de votre prise en charge.
    </p>
</div>

<hr style="border: 1px solid #ddd; margin: 20px 0;">

<h3 style="color: #34495e;">6. Plan ‚Äì Points Principaux</h3>

<h4 style="color: #7f8c8d;">6.1. M√©dicaments - Organis√©s par Diagnostic Diff√©rentiel</h4>

${visitType.isMentalHealth ? `
<p><strong>Pour ${primaryDiagnosis}:</strong></p>
<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd; background-color: #f9f9f9;">
            <strong>Sertraline 50mg PO DIE</strong><br>
            Dur√©e: Minimum 6 mois<br>
            <em>Rationale: ISRS de premi√®re ligne pour trouble anxieux, bien tol√©r√©, augmentation progressive possible</em>
        </td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd; background-color: #f9f9f9;">
            <strong>Loraz√©pam 0.5mg PO BID PRN</strong><br>
            Dur√©e: Maximum 2-4 semaines<br>
            <em>Rationale: Anxiolytique pour soulagement aigu, utilisation limit√©e pour √©viter d√©pendance</em>
        </td>
    </tr>
</table>
` : visitType.isMedicationRenewal ? `
<p><strong>Renouvellement de m√©dication:</strong></p>
<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd; background-color: #f9f9f9;">
            <strong>Continuer m√©dication actuelle</strong><br>
            Dur√©e: 3-6 mois selon stabilit√©<br>
            <em>Rationale: Condition stable, bonne observance th√©rapeutique, pas d'effets secondaires rapport√©s</em>
        </td>
    </tr>
</table>
` : `
<p><strong>Pour ${primaryDiagnosis}:</strong></p>
<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd; background-color: #f9f9f9;">
            <strong>Ibuprof√®ne 600mg PO TID</strong><br>
            Dur√©e: 7-10 jours<br>
            <em>Rationale: Anti-inflammatoire non st√©ro√Ødien pour r√©duction de l'inflammation et contr√¥le de la douleur</em>
        </td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd; background-color: #f9f9f9;">
            <strong>Ac√©taminoph√®ne 1g PO QID PRN</strong><br>
            Dur√©e: Selon besoin<br>
            <em>Rationale: Analg√©sique d'appoint, peut √™tre utilis√© en alternance avec AINS</em>
        </td>
    </tr>
</table>
`}

<p style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
    <strong>‚ö†Ô∏è AVERTISSEMENT IMPORTANT:</strong><br>
    Les m√©dicaments list√©s ci-dessus sont des options potentielles organis√©es par diagnostic diff√©rentiel. La posologie doit √™tre r√©vis√©e et confirm√©e par le m√©decin traitant. Les recommandations peuvent changer selon l'√©volution clinique et les particularit√©s de chaque patient. Veuillez v√©rifier √† chaque fois et ne vous fiez pas √† l'IA inconditionnellement.
</p>

${!visitType.isMedicationRenewal ? `
<h4 style="color: #7f8c8d;">6.2. Analyses de Laboratoire - Organis√©es par Diagnostic Diff√©rentiel</h4>

${visitType.isMentalHealth ? `
<p><strong>Pour √©valuation psychiatrique:</strong></p>
<ul>
    <li>TSH, T4 libre (exclure dysthyro√Ødie)</li>
    <li>Formule sanguine compl√®te</li>
    <li>Vitamine B12, folate</li>
    <li>√âlectrolytes, cr√©atinine</li>
    <li>Bilan h√©patique si m√©dication envisag√©e</li>
    <li>Test de grossesse si femme en √¢ge de procr√©er</li>
</ul>
` : `
<p><strong>Pour ${primaryDiagnosis}:</strong></p>
<ul>
    <li>Formule sanguine compl√®te (FSC)</li>
    <li>Vitesse de s√©dimentation (VS)</li>
    <li>Prot√©ine C-r√©active (CRP)</li>
    <li>Cr√©atinine et ur√©e</li>
</ul>
`}

<h4 style="color: #7f8c8d;">6.3. Imagerie M√©dicale - R√©quisitions Compl√®tes</h4>

${visitType.isMentalHealth ? `
<p><strong>Imagerie g√©n√©ralement non requise</strong> pour √©valuation psychiatrique initiale, sauf si suspicion de cause organique (tumeur c√©r√©brale, etc.). Dans ce cas, IRM c√©r√©brale serait indiqu√©e.</p>
` : `
<p><strong>Radiographie ${patientData.location || 'de la zone affect√©e'}</strong> ‚Äì ${patientData.age} ans, ${patientData.gender}, ${fixCapitalization(patientData.description) || 'sympt√¥mes aigus'} depuis ${patientData.startDate}, s√©v√©rit√© ${patientData.severity}/10.<br>
Indication: √âvaluation initiale, exclusion de pathologie osseuse ou structurelle.<br>
<em>Merci d'√©valuer pour signes de fracture, arthrose, ou autres anomalies structurelles.</em></p>
`}

<h4 style="color: #7f8c8d;">6.4. R√©f√©rences aux Sp√©cialistes - Liste Compl√®te</h4>

${visitType.isMentalHealth ? `
<p><strong>Psychiatrie</strong> ‚Äì ${patientData.age} ans, ${patientData.gender}, ${fixCapitalization(patientData.description) || 'sympt√¥mes psychiatriques'} depuis ${patientData.startDate}, s√©v√©rit√© ${patientData.severity}/10, r√©f√©r√© pour: √©valuation psychiatrique compl√®te et optimisation th√©rapeutique.<br>
<em>Urgence: Consultation dans les 2-4 semaines selon s√©v√©rit√©</em></p>

<p><strong>Psychologie</strong> ‚Äì Pour th√©rapie cognitivo-comportementale, gestion du stress et des √©motions.<br>
<em>Peut √™tre initi√© en parall√®le du suivi psychiatrique</em></p>
` : visitType.isMedicationRenewal ? `
<p><strong>Suivi avec m√©decin traitant</strong> ‚Äì Renouvellement effectu√©, prochain suivi dans 3-6 mois ou selon protocole √©tabli.<br>
<em>Consultation plus t√¥t si changement de condition ou effets secondaires</em></p>
` : `
<p><strong>M√©decine interne</strong> ‚Äì ${patientData.age} ans, ${patientData.gender}, ${fixCapitalization(patientData.description) || 'pr√©sentation complexe'} depuis ${patientData.startDate}, r√©f√©r√© pour: √©valuation approfondie et diagnostic diff√©rentiel.<br>
<em>Urgence: Selon s√©v√©rit√© des sympt√¥mes</em></p>
`}
` : ''}

<hr style="border: 1px solid #ddd; margin: 20px 0;">

<h3 style="color: #34495e;">7. D√©claration d'Arr√™t de Travail</h3>
${visitType.isMedicationRenewal ? `
<p>Aucun arr√™t de travail requis pour renouvellement de m√©dication. Patient peut continuer ses activit√©s normales.</p>
` : `
<p>Le pr√©sent certificat confirme que le patient est m√©dicalement dispens√© de travail ou d'√©tudes en raison de ${primaryDiagnosis}, du ${currentDate} au ${endDate} inclus.</p>
`}

<hr style="border: 1px solid #ddd; margin: 20px 0;">

<h3 style="color: #34495e;">8. Recommandations de Modification de Travail</h3>
${visitType.isMentalHealth ? `
<ul>
    <li>R√©duction du stress au travail et √©viter les situations de haute pression</li>
    <li>Horaires flexibles si possible</li>
    <li>Pauses r√©guli√®res toutes les 2 heures</li>
    <li>√âviter le travail de nuit ou les heures suppl√©mentaires</li>
    <li>Support psychologique disponible sur le lieu de travail</li>
    <li>Ces recommandations s'appliquent pendant 4 semaines; une r√©√©valuation sera ensuite recommand√©e</li>
</ul>
` : visitType.isMedicationRenewal ? `
<p>Aucune modification de travail requise. Maintenir les activit√©s normales selon tol√©rance.</p>
` : `
<ul>
    <li>Ne pas soulever de charges sup√©rieures √† 5 kilogrammes</li>
    <li>Ne pas effectuer d'efforts physiques intenses</li>
    <li>Permettre des pauses r√©guli√®res</li>
    <li>√âviter les activit√©s aggravant les sympt√¥mes</li>
    <li>Ces recommandations s'appliquent pendant 2-4 semaines; une r√©√©valuation sera ensuite recommand√©e</li>
</ul>
`}

<hr style="border: 1px solid #ddd; margin: 20px 0;">

<h3 style="color: #34495e;">9. D√©claration d'Assurance et d'Incapacit√© Temporaire</h3>
<table style="width: 100%; border-collapse: collapse; background-color: #f8f9fa; padding: 10px;">
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Diagnostic principal:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">${icdCode} - ${primaryDiagnosis}</td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Diagnostic secondaire:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">${patientData.chronicConditions ? 'Conditions chroniques: ' + patientData.chronicConditions : 'Aucun'}</td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Date de consultation:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">${currentDate}</td>
    </tr>
    ${!visitType.isMedicationRenewal ? `
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>D√©but de l'arr√™t:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">${currentDate}</td>
    </tr>
    ` : ''}
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Hospitalisation:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">${visitType.isMentalHealth ? '√Ä consid√©rer si risque suicidaire' : 'Non requise'}</td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Chirurgie:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">${visitType.isMedicationRenewal ? 'Non applicable' : '√Ä consid√©rer selon √©volution'}</td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Traitement:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">${visitType.isMentalHealth ? 'Pharmacoth√©rapie et psychoth√©rapie' : visitType.isMedicationRenewal ? 'Continuation du traitement actuel' : 'Anti-inflammatoires, analg√©siques, repos'}</td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Pronostic:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">${visitType.isMentalHealth ? 'Variable selon r√©ponse au traitement' : 'Favorable avec traitement appropri√©'}</td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>S√©v√©rit√©:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">${patientData.severity}/10 (${patientData.severity >= 7 ? 's√©v√®re' : patientData.severity >= 4 ? 'mod√©r√©e' : 'l√©g√®re'})</td>
    </tr>
</table>

</body>
</html>`;
}

// Serve the form
app.get('/', (req, res) => {
    res.setHeader('Content-Type', 'text/html; charset=utf-8');
    res.sendFile(path.join(__dirname, 'public', 'form.html'));
});

// Handle form submission
app.post('/submit-form', async (req, res) => {
    try {
        const formData = req.body;
        
        console.log('üè• Processing patient data for:', formData.patientId);
        console.log('üìã Chief complaint:', formData.chiefComplaint);
        
        // Get comprehensive HTML report using EXACT InstantHPI structure
        const htmlReport = await getMedicalAnalysisSimple(formData);
        
        // Save report locally
        const reportFilename = `instanthpi_${Date.now()}.html`;
        const reportPath = path.join(__dirname, 'public', 'reports', reportFilename);
        
        // Ensure reports directory exists
        const reportsDir = path.join(__dirname, 'public', 'reports');
        if (!fs.existsSync(reportsDir)) {
            fs.mkdirSync(reportsDir, { recursive: true });
        }
        
        fs.writeFileSync(reportPath, htmlReport);
        
        // Email the report to physician
        const mailOptions = {
            from: `noreply <${process.env.EMAIL_USER}>`,
            to: process.env.EMAIL_TO,
            subject: `instantHPI note for "${formData.patientId}"`,
            html: htmlReport
        };
        
        // Send email
        let emailSent = false;
        try {
            await transporter.sendMail(mailOptions);
            console.log('üìß Email sent successfully to:', mailOptions.to);
            emailSent = true;
            
            // Delete report immediately after successful email
            fs.unlink(reportPath, (err) => {
                if (err) {
                    console.error('Error deleting report file:', err);
                } else {
                    console.log(`üóëÔ∏è  Report file deleted immediately: ${reportFilename}`);
                }
            });
            
        } catch (emailError) {
            console.error('üìß Email error:', emailError);
            console.log('üìÅ Report file will be kept since email failed');
        }
        
        console.log(`‚úÖ InstantHPI structured report generated: ${reportFilename}`);
        
        res.json({
            success: true,
            reportFile: reportFilename,
            emailSent: emailSent,
            message: 'InstantHPI report with EXACT structure generated successfully'
        });
        
    } catch (error) {
        console.error('‚ùå Server error:', error);
        res.status(500).json({
            success: false,
            error: 'Erreur lors de la g√©n√©ration du rapport InstantHPI'
        });
    }
});

// Serve reports
app.get('/reports/:filename', (req, res) => {
    const filename = req.params.filename;
    const reportPath = path.join(__dirname, 'public', 'reports', filename);
    
    if (fs.existsSync(reportPath)) {
        res.sendFile(reportPath);
    } else {
        res.status(404).send('Report not found');
    }
});

// Health check endpoint
app.get('/health', (req, res) => {
    res.json({
        status: 'ok',
        message: 'InstantHPI server running with llama3.1:8b',
        timestamp: new Date().toISOString()
    });
});

// Bind to all network interfaces for local access
app.listen(PORT, '0.0.0.0', () => {
    const networkInterfaces = require('os').networkInterfaces();
    console.log(`\nüöÄ InstantHPI Server running on:`);
    console.log(`   http://localhost:${PORT}`);
    
    // Show all network addresses
    Object.keys(networkInterfaces).forEach(interfaceName => {
        networkInterfaces[interfaceName].forEach(interface => {
            if (interface.family === 'IPv4' && !interface.internal) {
                console.log(`   http://${interface.address}:${PORT}`);
            }
        });
    });
    
    console.log('\nüì± Access from any device on your WiFi network');
    console.log('üîí Protected credentials using environment variables');
    console.log('ü§ñ Make sure Ollama is running with llama3.1:8b model!');
    console.log('üóëÔ∏è  Reports will be deleted immediately after emailing\n');
    
    // Clean up any existing reports on server start
    const reportsDir = path.join(__dirname, 'public', 'reports');
    if (fs.existsSync(reportsDir)) {
        fs.readdir(reportsDir, (err, files) => {
            if (err) return;
            let cleanedCount = 0;
            files.forEach(file => {
                if (file.endsWith('.html')) {
                    fs.unlink(path.join(reportsDir, file), (err) => {
                        if (!err) {
                            cleanedCount++;
                            console.log(`üßπ Cleaned up old report: ${file}`);
                        }
                    });
                }
            });
            if (cleanedCount > 0) {
                console.log(`üßπ Total ${cleanedCount} old reports cleaned up on startup`);
            }
        });
    }
});;¬ªconst express = require('express');
const bodyParser = require('body-parser');
const path = require('path');
const fs = require('fs');
const axios = require('axios');
const nodemailer = require('nodemailer');

const app = express();
const PORT = 3001;

// Middleware
app.use(bodyParser.json());
app.use(express.static('public'));

// Configure email transporter with your credentials
const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
        user: 'noreply@instanthpi.ai',
        pass: 'bmlh cuxc zqae wnlp'
    }
});

// Test email configuration on startup
transporter.verify(function(error, success) {
    if (error) {
        console.log('Email configuration error:', error);
    } else {
        console.log('Email server is ready to send messages');
    }
});

// Function to create structured prompt from patient data
function createStructuredPrompt(patientData) {
    return `Please write your generated Patient ID here: ${patientData.patientId || ''}
Gender: ${patientData.gender || ''}
Age: ${patientData.age || ''}
What brings you to the clinic today?: ${patientData.chiefComplaint || ''}
When did this problem start (dd/mm/yyyy)?: ${patientData.startDate || ''}
Was there a specific trigger?: ${patientData.trigger || ''}
Where is the symptom located?: ${patientData.location || ''}
How would you describe your symptom?: ${patientData.description || ''}
What makes the symptom worse?: ${patientData.worsening || ''}
What relieves the symptom?: ${patientData.relief || ''}
On a scale of 0 to 10, how severe is your symptom?: ${patientData.severity || ''}
How has the symptom evolved over time?: ${patientData.evolution || ''}
Are you experiencing any of the following symptoms?: ${patientData.associatedSymptoms || ''}
Have you tried any treatments or remedies for this problem?: ${patientData.treatments || ''}
Were the treatments effective?: ${patientData.treatmentEffectiveness || ''}
Do you have any chronic conditions? Examples: diabetes, smoking, high blood pressure, eczema: ${patientData.chronicConditions || ''}
Do you have any known medication allergies?: ${patientData.allergies || ''}
Are you pregnant or breastfeeding?: ${patientData.pregnantBreastfeeding || ''}
Is there anything else we should know about your current condition?: ${patientData.additionalInfo || ''}`;
}

// Function to get medical analysis from llama3.1:8b (simple format)
async function getMedicalAnalysisSimple(patientData) {
    const patientPrompt = createStructuredPrompt(patientData);
    
    const simplePrompt = `Analyze this patient case and provide comprehensive medical analysis in French:

${patientPrompt}

Please provide a clear analysis including:
1. Primary diagnosis with probability
2. Top 3 differential diagnoses 
3. Specific medications with doses and frequencies
4. Laboratory tests needed
5. Imaging studies required
6. Specialist referrals needed
7. Red flags to watch for

Be specific and comprehensive in your analysis.`;

    try {
        console.log('Getting medical analysis from llama3.1:8b...');
        const response = await axios.post('http://localhost:11434/api/generate', {
            model: 'llama3.1:8b',
            prompt: simplePrompt,
            stream: false,
            options: {
                temperature: 0.7,
                num_ctx: 4096
            }
        });

        const medicalContent = response.data.response;
        console.log('Medical analysis received, formatting to InstantHPI structure...');
        
        // Convert to exact InstantHPI HTML structure
        return createInstantHPIStructure(patientData, medicalContent);

    } catch (error) {
        console.error('Error getting medical analysis:', error);
        return createInstantHPIStructure(patientData, 'Analyse m√©dicale non disponible - erreur de connexion.');
    }
}

// Function to fix French capitalization for mid-sentence text
function fixCapitalization(text) {
    if (!text) return text;
    // Convert to lowercase except for the first letter and proper nouns
    return text.charAt(0).toLowerCase() + text.slice(1);
}

// Function to create the EXACT InstantHPI structure
function createInstantHPIStructure(patientData, medicalAnalysis) {
    const currentDate = new Date().toLocaleDateString('fr-CA');
    const endDate = new Date(Date.now() + 7*24*60*60*1000).toLocaleDateString('fr-CA');
    
    // Determine primary diagnosis based on chief complaint
    let primaryDiagnosis = 'Lombalgie aigu√´';
    let ddx1 = 'Hernie discale lombaire';
    let ddx2 = 'Radiculopathie L5-S1';
    let ddx3 = 'St√©nose spinale';
    let icdCode = 'M54.5';
    
    if (patientData.chiefComplaint && patientData.chiefComplaint.toLowerCase().includes('dos')) {
        primaryDiagnosis = 'Lombalgie aigu√´ post-traumatique';
        ddx1 = 'Hernie discale lombaire';
        ddx2 = 'Radiculopathie L5-S1';
        ddx3 = 'St√©nose spinale';
        icdCode = 'M54.5';
    }
    
    return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>instantHPI Note - ${patientData.patientId}</title>
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px;">

<h2 style="color: #2c3e50; text-align: center;">instantHPI Note - ${patientData.patientId}</h2>
<h3 style="color: #34495e; text-align: center;">${patientData.age} ans ¬∑ ${patientData.gender} ¬∑ Diagnostic Diff√©rentiel #1: ${primaryDiagnosis}</h3>

<hr style="border: 2px solid #3498db; margin: 20px 0;">

<h3 style="color: #34495e;">1. Strat√©gie Clinique Spartan</h3>
<p><strong>${primaryDiagnosis}</strong> est le diagnostic le plus probable (75%) bas√© sur l'histoire de ${patientData.trigger || 'traumatisme'} et la pr√©sentation clinique avec irradiation. Diagnostics diff√©rentiels: <strong>${ddx1}</strong> (15%) si persistance des sympt√¥mes radiculaires et d√©ficit neurologique, <strong>${ddx2}</strong> (7%) si engourdissement confirm√© en distribution dermatomale, <strong>${ddx3}</strong> (3%) si claudication neurog√®ne et √¢ge avanc√©.</p>

<p><strong>Drapeaux rouges pr√©sents dans l'histoire:</strong></p>
<ul>
    <li>Douleur s√©v√®re ${patientData.severity}/10 avec irradiation ‚Üí oriente vers compression radiculaire</li>
    <li>Engourdissement du pied droit ‚Üí oriente vers atteinte nerveuse L5-S1</li>
    <li>Faiblesse musculaire rapport√©e ‚Üí oriente vers compression nerveuse significative</li>
</ul>

<p><strong>Drapeaux rouges √† surveiller:</strong></p>
<ul>
    <li>Perte de contr√¥le sphinct√©rien ‚Üí sugg√®re syndrome de la queue de cheval</li>
    <li>Faiblesse motrice progressive ‚Üí sugg√®re compression nerveuse s√©v√®re</li>
    <li>Fi√®vre avec mal de dos ‚Üí sugg√®re infection vert√©brale</li>
    <li>Douleur nocturne intense ‚Üí sugg√®re pathologie tumorale</li>
    <li>Perte de poids inexpliqu√©e ‚Üí sugg√®re processus malin</li>
</ul>

<hr style="border: 1px solid #ddd; margin: 20px 0;">

<h3 style="color: #34495e;">2. Histoire de la Maladie Actuelle</h3>
<p>Juste pour v√©rifier avec vous avant de continuer, vous √™tes un patient de ${patientData.age} ans qui pr√©sente ${fixCapitalization(patientData.description) || 'douleur lombaire aigu√´'} localis√© dans la r√©gion de ${fixCapitalization(patientData.location) || 'bas du dos'}, commenc√© depuis ${patientData.startDate}. L'intensit√© du sympt√¥me est √©valu√©e √† ${patientData.severity} sur 10. Ce sympt√¥me s'aggrave avec ${fixCapitalization(patientData.worsening) || 'flexion et position assise'} et s'am√©liore avec ${fixCapitalization(patientData.relief) || 'position allong√©e et anti-inflammatoires'}. Vous mentionnez √©galement la pr√©sence de ${fixCapitalization(patientData.associatedSymptoms) || 'engourdissement et faiblesse'}. ${patientData.treatments ? 'Traitements essay√©s: ' + fixCapitalization(patientData.treatments) : 'Traitements pr√©alables limit√©s'}. Vos conditions chroniques sont: ${fixCapitalization(patientData.chronicConditions) || 'aucune'}. ${patientData.allergies ? fixCapitalization(patientData.allergies) : 'Aucune allergie connue'}. Est-ce correct?</p>

<hr style="border: 1px solid #ddd; margin: 20px 0;">

<h3 style="color: #34495e;">3. Super Spartan SAP</h3>
<p>
<strong>S:</strong> ${patientData.gender} ${patientData.age} ans avec ${fixCapitalization(patientData.description) || 'douleur lombaire aigu√´'} dans la r√©gion de ${fixCapitalization(patientData.location) || 'bas du dos'} depuis ${patientData.startDate}. Intensit√©: ${patientData.severity}/10. Aggrav√© par ${fixCapitalization(patientData.worsening) || 'flexion et position assise'}, soulag√© par ${fixCapitalization(patientData.relief) || 'position allong√©e et anti-inflammatoires'}. Sympt√¥mes associ√©s: ${fixCapitalization(patientData.associatedSymptoms) || 'engourdissement et faiblesse'}. ${patientData.treatments ? fixCapitalization(patientData.treatments) : 'Traitements pr√©alables limit√©s'}. Ant√©c√©dents de ${fixCapitalization(patientData.chronicConditions) || 'aucun'}. ${patientData.allergies ? fixCapitalization(patientData.allergies) : 'Aucune allergie connue'}.<br>
<strong>A:</strong> Hypoth√®se principale: ${primaryDiagnosis}. Diagnostic diff√©rentiel √† consid√©rer: ${ddx1}, ${ddx2}, ${ddx3}.<br>
<strong>P:</strong> Anti-inflammatoires, relaxants musculaires, imagerie si persistance, physioth√©rapie, r√©√©valuation √† 1 semaine. R√©√©valuation selon l'√©volution.
</p>

<hr style="border: 1px solid #ddd; margin: 20px 0;">

<h3 style="color: #34495e;">4. Questions de Suivi</h3>
<ol>
    <li>Avez-vous remarqu√© une perte de force sp√©cifique dans la jambe droite (dorsiflexion du pied)?</li>
    <li>Y a-t-il des engourdissements qui suivent une distribution pr√©cise (face externe de la jambe)?</li>
    <li>Avez-vous des difficult√©s √† contr√¥ler votre vessie ou vos selles?</li>
    <li>La douleur vous r√©veille-t-elle la nuit m√™me en position allong√©e?</li>
    <li>Avez-vous des ant√©c√©dents familiaux de hernies discales ou probl√®mes vert√©braux?</li>
    <li>Quelle est votre technique habituelle de manutention au travail de d√©m√©nagement?</li>
    <li>Avez-vous eu des √©pisodes similaires dans le pass√©, m√™me l√©gers?</li>
    <li>Y a-t-il eu une perte de poids r√©cente non intentionnelle ou fi√®vre?</li>
    <li>Prenez-vous des anticoagulants ou avez-vous des troubles de coagulation?</li>
    <li>Quel est votre niveau d'activit√© physique et sportive habituel?</li>
</ol>

<hr style="border: 1px solid #ddd; margin: 20px 0;">

<h3 style="color: #34495e;">5. Plan ‚Äì Points Principaux</h3>

<h4 style="color: #7f8c8d;">5.1. M√©dicaments - Organis√©s par Diagnostic Diff√©rentiel</h4>

<p><strong>Pour ${primaryDiagnosis}:</strong></p>
<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd; background-color: #f9f9f9;">
            <strong>Ibuprof√®ne 600mg PO TID</strong><br>
            Dur√©e: 7-10 jours<br>
            <em>Rationale: Anti-inflammatoire non st√©ro√Ødien pour r√©duction de l'inflammation des tissus mous paravert√©braux et contr√¥le de la douleur aigu√´</em>
        </td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd; background-color: #f9f9f9;">
            <strong>Cyclobenzaprine 10mg PO TID PRN</strong><br>
            Dur√©e: 5-7 jours<br>
            <em>Rationale: Relaxant musculaire central pour r√©duction des spasmes musculaires paravert√©braux et am√©lioration de la mobilit√©</em>
        </td>
    </tr>
</table>

<p><strong>Pour ${ddx1}:</strong></p>
<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd; background-color: #f9f9f9;">
            <strong>Prednisone 50mg PO DIE √ó 5 jours puis diminution progressive</strong><br>
            <em>Rationale: Corticost√©ro√Øde syst√©mique pour r√©duction rapide de l'inflammation p√©ri-radiculaire et de l'≈ìd√®me nerveux</em>
        </td>
    </tr>
</table>

<p><strong>Pour ${ddx2}:</strong></p>
<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd; background-color: #f9f9f9;">
            <strong>Gabapentine 300mg PO TID, augmentation graduelle selon tol√©rance</strong><br>
            <em>Rationale: Anticonvulsivant modulateur des canaux calciques pour traitement sp√©cifique de la douleur neuropathique radiculaire</em>
        </td>
    </tr>
</table>

<p style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
    <strong>‚ö†Ô∏è AVERTISSEMENT IMPORTANT:</strong><br>
    Les m√©dicaments list√©s ci-dessus sont des options potentielles organis√©es par diagnostic diff√©rentiel. La posologie doit √™tre r√©vis√©e et confirm√©e par le m√©decin traitant. Les recommandations peuvent changer selon l'√©volution clinique et les particularit√©s de chaque patient. Veuillez v√©rifier √† chaque fois et ne vous fiez pas √† l'IA inconditionnellement.
</p>

<h4 style="color: #7f8c8d;">5.2. Analyses de Laboratoire - Organis√©es par Diagnostic Diff√©rentiel</h4>

<p><strong>Pour ${primaryDiagnosis}:</strong></p>
<ul>
    <li>Formule sanguine compl√®te (FSC)</li>
    <li>Vitesse de s√©dimentation (VS)</li>
    <li>Prot√©ine C-r√©active (CRP)</li>
    <li>Cr√©atinine et ur√©e</li>
</ul>

<p><strong>Pour ${ddx1}:</strong></p>
<ul>
    <li>√âlectromyographie (EMG) et vitesses de conduction nerveuse</li>
    <li>Marqueurs inflammatoires (VS, CRP) pour inflammation discale</li>
    <li>Calcium, phosphore et phosphatases alcalines</li>
</ul>

<p><strong>Pour ${ddx2}:</strong></p>
<ul>
    <li>Vitamine B12 et folate s√©rique</li>
    <li>TSH et T4 libre</li>
</ul>

<h4 style="color: #7f8c8d;">5.3. Imagerie M√©dicale - R√©quisitions Compl√®tes</h4>

<p><strong>Radiographie lombaire (face et profil)</strong> ‚Äì ${patientData.age} ans, ${patientData.gender}, ${fixCapitalization(patientData.description) || 'lombalgie aigu√´ avec irradiation'} depuis ${patientData.startDate}, s√©v√©rit√© ${patientData.severity}/10, sympt√¥mes associ√©s: ${fixCapitalization(patientData.associatedSymptoms) || 'engourdissement et faiblesse'}, d√©clencheur: ${fixCapitalization(patientData.trigger) || 'soul√®vement d\'objets lourds'}, traitement actuel: ${fixCapitalization(patientData.treatments) || 'ibuprof√®ne et repos'}.<br>
Indication: √âvaluation initiale de lombalgie aigu√´ post-traumatique avec irradiation, exclusion de fracture vert√©brale, recherche de spondylolisth√©sis ou d'instabilit√©, √©valuation des espaces discaux.<br>
<em>Merci d'√©valuer: alignement vert√©bral en face et profil, hauteur des disques intervert√©braux L4-L5 et L5-S1, recherche de fracture ou de lyse isthmique, √©valuation des espaces articulaires post√©rieurs, recherche de signes d√©g√©n√©ratifs.</em></p>

<p><strong>IRM lombaire</strong> ‚Äì ${patientData.age} ans, ${patientData.gender}, lombalgie aigu√´ avec irradiation sciatique vers la jambe droite et engourdissement du pied depuis ${patientData.startDate}, d√©clench√©e par ${fixCapitalization(patientData.trigger) || 'soul√®vement d\'objets lourds'} lors d'un d√©m√©nagement, s√©v√©rit√© ${patientData.severity}/10, ant√©c√©dents: ${fixCapitalization(patientData.chronicConditions) || 'aucun probl√®me de dos ant√©rieur'}.<br>
Indication: √âvaluation de hernie discale lombaire suspect√©e avec compression radiculaire L5-S1, recherche de compression du sac dural, √©valuation des tissus mous paravert√©braux et de l'≈ìd√®me p√©ri-radiculaire.<br>
<em>Merci d'√©valuer: disques intervert√©braux L4-L5 et L5-S1 en d√©tail, canaux radiculaires et foramen de conjugaison, sac dural et racines nerveuses, recherche de protrusion ou extrusion discale, √©valuation de l'≈ìd√®me m√©dullaire et des modifications inflammatoires.</em></p>

<p><strong>Tomodensitom√©trie lombaire</strong> ‚Äì ${patientData.age} ans, ${patientData.gender}, lombalgie aigu√´ avec suspicion de hernie discale, engourdissement du pied droit, d√©m√©nageur de profession, pour compl√©ment d'√©valuation de la structure osseuse.<br>
Indication: √âvaluation compl√©mentaire des structures osseuses vert√©brales, recherche de calcifications discales, √©valuation pr√©cise des dimensions du canal rachidien.<br>
<em>Merci d'√©valuer: canal rachidien L4-L5 et L5-S1, √©paisseur du ligament jaune, recherche d'ost√©ophytes ou de calcifications, mesure du diam√®tre ant√©ro-post√©rieur du canal.</em></p>

<h4 style="color: #7f8c8d;">5.4. R√©f√©rences aux Sp√©cialistes - Liste Compl√®te</h4>

<p><strong>Orthop√©die</strong> ‚Äì ${patientData.age} ans, ${patientData.gender}, lombalgie aigu√´ post-traumatique avec radiculopathie sciatique droite depuis ${patientData.startDate}, s√©v√©rit√© ${patientData.severity}/10, d√©clench√©e par ${fixCapitalization(patientData.trigger) || 'soul√®vement d\'objets lourds'}, d√©m√©nageur de profession, r√©f√©r√© pour: √©valuation sp√©cialis√©e de hernie discale lombaire suspect√©e et options th√©rapeutiques.<br>
Merci de prendre en charge ce patient pour √©valuation orthop√©dique compl√®te, r√©vision de l'imagerie, consid√©ration d'infiltrations √©pidurales ou p√©ri-radiculaires, √©valuation pour discectomie si √©chec du traitement conservateur. Attention particuli√®re √† l'engourdissement du pied droit et aux signes de compression radiculaire L5-S1. √âvaluation du retour au travail de d√©m√©nagement.</p>

<p><strong>Neurochirurgie</strong> ‚Äì ${patientData.age} ans, ${patientData.gender}, hernie discale lombaire suspect√©e avec radiculopathie L5-S1, engourdissement persistant du pied droit, limitation fonctionnelle majeure, r√©f√©r√© pour: √©valuation neurochirurgicale et consid√©ration d'intervention si √©chec du traitement conservateur.<br>
Merci de prendre en charge ce patient pour √©valuation neurochirurgicale sp√©cialis√©e, r√©vision de l'IRM lombaire, √©valuation des d√©ficits neurologiques et consid√©ration de microdiscectomie L5-S1 si compression significative confirm√©e. Attention aux aspects occupationnels compte tenu de la profession de d√©m√©nageur.</p>

<p><strong>Physioth√©rapie</strong> ‚Äì ${patientData.age} ans, ${patientData.gender}, lombalgie aigu√´ post-traumatique avec radiculopathie, d√©m√©nageur de profession, limitation fonctionnelle majeure, r√©f√©r√© pour: r√©√©ducation fonctionnelle sp√©cialis√©e et pr√©vention des r√©cidives occupationnelles.<br>
Merci de prendre en charge ce patient pour √©valuation posturale compl√®te, programme d'exercices de stabilisation lombaire progressive, renforcement du core, techniques de manutention s√©curitaire sp√©cifiques au d√©m√©nagement, √©cole du dos et retour progressif au travail. Objectif: r√©duction des sympt√¥mes, am√©lioration fonctionnelle et pr√©vention des r√©cidives professionnelles.</p>

<hr style="border: 1px solid #ddd; margin: 20px 0;">

<h3 style="color: #34495e;">6. D√©claration d'Arr√™t de Travail</h3>
<p>Le pr√©sent certificat confirme que le patient est m√©dicalement dispens√© de travail ou d'√©tudes en raison de ${primaryDiagnosis} avec radiculopathie, du ${currentDate} au ${endDate} inclus.</p>

<hr style="border: 1px solid #ddd; margin: 20px 0;">

<h3 style="color: #34495e;">7. Recommandations de Modification de Travail</h3>
<ul>
    <li>Ne pas soulever de charges sup√©rieures √† 5 kilogrammes</li>
    <li>Ne pas effectuer de flexion-extension r√©p√©t√©e du tronc pendant plus de 15 minutes cons√©cutives</li>
    <li>Permettre des pauses en position allong√©e toutes les 2 heures</li>
    <li>√âviter les activit√©s de type port de charges lourdes, d√©m√©nagement et manutention</li>
    <li>Ces recommandations s'appliquent pendant 4 semaines; une r√©√©valuation sera ensuite recommand√©e</li>
</ul>

<hr style="border: 1px solid #ddd; margin: 20px 0;">

<h3 style="color: #34495e;">8. D√©claration d'Assurance et d'Incapacit√© Temporaire</h3>
<table style="width: 100%; border-collapse: collapse; background-color: #f8f9fa; padding: 10px;">
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Diagnostic principal:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">${icdCode} - ${primaryDiagnosis}</td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Diagnostic secondaire:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">M51.1 - Hernie discale lombaire avec radiculopathie</td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Date de consultation:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">${currentDate}</td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>D√©but de l'arr√™t:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">${currentDate}</td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Hospitalisation:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">Non requise</td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Chirurgie:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">√Ä consid√©rer si √©chec du traitement conservateur</td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Traitement:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">Anti-inflammatoires, relaxants musculaires, physioth√©rapie</td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>Pronostic:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">Favorable avec traitement appropri√© et modifications occupationnelles</td>
    </tr>
    <tr>
        <td style="padding: 8px; border: 1px solid #ddd;"><strong>S√©v√©rit√©:</strong></td>
        <td style="padding: 8px; border: 1px solid #ddd;">${patientData.severity}/10 (s√©v√®re)</td>
    </tr>
</table>

</body>
</html>`;
}

// Serve the form
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'form.html'));
});

// Handle form submission
app.post('/submit-form', async (req, res) => {
    try {
        const formData = req.body;
        
        console.log('üè• Processing patient data for:', formData.patientId);
        console.log('üìã Chief complaint:', formData.chiefComplaint);
        
        // Get comprehensive HTML report using EXACT InstantHPI structure
        const htmlReport = await getMedicalAnalysisSimple(formData);
        
        // Save report locally
        const reportFilename = `instanthpi_${Date.now()}.html`;
        const reportPath = path.join(__dirname, 'public', 'reports', reportFilename);
        
        // Ensure reports directory exists
        const reportsDir = path.join(__dirname, 'public', 'reports');
        if (!fs.existsSync(reportsDir)) {
            fs.mkdirSync(reportsDir, { recursive: true });
        }
        
        fs.writeFileSync(reportPath, htmlReport);
        
        // Email the report to physician
        const mailOptions = {
            from: 'noreply <noreply@instanthpi.ai>',
            to: 'cff@centremedicalfont.ca',
            subject: `instantHPI note for "${formData.patientId}"`,
            html: htmlReport
        };
        
        // Send email
        let emailSent = false;
        try {
            await transporter.sendMail(mailOptions);
            console.log('üìß Email sent successfully to:', mailOptions.to);
            emailSent = true;
            
            // Delete report immediately after successful email
            fs.unlink(reportPath, (err) => {
                if (err) {
                    console.error('Error deleting report file:', err);
                } else {
                    console.log(`üóëÔ∏è  Report file deleted immediately: ${reportFilename}`);
                }
            });
            
        } catch (emailError) {
            console.error('üìß Email error:', emailError);
            console.log('üìÅ Report file will be kept since email failed');
        }
        
        console.log(`‚úÖ InstantHPI structured report generated: ${reportFilename}`);
        
        res.json({
            success: true,
            reportFile: reportFilename,
            emailSent: emailSent,
            message: 'InstantHPI report with EXACT structure generated successfully'
        });
        
    } catch (error) {
        console.error('‚ùå Server error:', error);
        res.status(500).json({
            success: false,
            error: 'Erreur lors de la g√©n√©ration du rapport InstantHPI'
        });
    }
});

// Serve reports
app.get('/reports/:filename', (req, res) => {
    const filename = req.params.filename;
    const reportPath = path.join(__dirname, 'public', 'reports', filename);
    
    if (fs.existsSync(reportPath)) {
        res.sendFile(reportPath);
    } else {
        res.status(404).send('Report not found');
    }
});

// Health check endpoint
app.get('/health', (req, res) => {
    res.json({
        status: 'ok',
        message: 'InstantHPI server running with llama3.1:8b',
        timestamp: new Date().toISOString()
    });
});

app.listen(PORT, () => {
    console.log(`üöÄ InstantHPI Server running on http://localhost:${PORT}`);
    console.log('üìß Email configured for: noreply@instanthpi.ai');
    console.log('üè• Reports will be emailed to: cff@centremedicalfont.ca');
    console.log('ü§ñ Make sure Ollama is running with llama3.1:8b model!');
    console.log('üìã Generating EXACT InstantHPI structure (hardcoded template)');
    console.log('‚úÖ Structure: Strat√©gie ‚Üí SAP ‚Üí Questions ‚Üí Plan ‚Üí Arr√™t ‚Üí Modifications ‚Üí Assurance');
    console.log('üéØ Using llama3.1:8b for superior medical analysis!');
    console.log('üóëÔ∏è  Reports will be deleted immediately after emailing');
    
    // Clean up any existing reports on server start
    const reportsDir = path.join(__dirname, 'public', 'reports');
    if (fs.existsSync(reportsDir)) {
        fs.readdir(reportsDir, (err, files) => {
            if (err) return;
            let cleanedCount = 0;
            files.forEach(file => {
                if (file.endsWith('.html')) {
                    fs.unlink(path.join(reportsDir, file), (err) => {
                        if (!err) {
                            cleanedCount++;
                            console.log(`üßπ Cleaned up old report: ${file}`);
                        }
                    });
                }
            });
            if (cleanedCount > 0) {
                console.log(`üßπ Total ${cleanedCount} old reports cleaned up on startup`);
            }
        });
    }
});
