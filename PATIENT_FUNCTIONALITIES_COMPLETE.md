# üìã COMPLETE PATIENT FUNCTIONALITIES & TRIAGE SEQUENCE

## üéØ EXECUTIVE SUMMARY

InstantHPI provides a comprehensive patient workflow with AI-powered triage that follows the **Canadian Triage and Acuity Scale (CTAS)**. The system processes patient information through multiple stages to generate professional medical documentation.

---

## üîÑ COMPLETE TRIAGE SEQUENCE

### **STEP 1: Patient Form Submission**
**Location:** `client/src/components/patient/PatientIntakeForm.tsx`

**Data Collected:**
- **Demographics:** Age, Gender, De-identified Patient ID (10-character alphanumeric)
- **Chief Complaint:** Reason for visit
- **Symptom Details:**
  - Problem start date
  - Specific trigger
  - Symptom location
  - Symptom description
  - Aggravating factors
  - Relieving factors
  - Symptom progression
  - Selected symptoms checklist
- **Medical History:**
  - Chronic conditions
  - Medication allergies
  - Pregnancy status
  - Current medications
- **Treatment History:**
  - Treatments attempted
  - Treatment effectiveness
  - Previous diagnoses
- **Additional Information:**
  - Emergency contact
  - Insurance info
  - Additional notes

**Action:** Patient submits form ‚Üí Triggers `/api/comprehensive-triage` API call

---

### **STEP 2: AI Triage Processing**
**API:** `/api/comprehensive-triage`  
**Location:** `netlify/functions/comprehensive-triage.js`

**What Happens:**
1. Patient data sent to AI (OpenAI GPT-4o or Anthropic Claude)
2. AI analyzes symptoms using CTAS (Canadian Triage and Acuity Scale)
3. Generates **12 comprehensive medical sections** in French

**Triage Levels Generated (P1-P5):**
- **P1 (EMERGENCY):** Life-threatening, requires immediate intervention
  - Care Location: `"911 (Transport en ambulance requis)"`
  
- **P2 (URGENT):** Potentially life-threatening, should be seen within 15 minutes
  - Care Location: `"Urgence hospitali√®re (Transport personnel ou ambulance)"`
  
- **P3 (SEMI-URGENT):** Could become serious, should be seen within 30 minutes
  - Care Location: `"Urgence hospitali√®re ou urgence mineure"`
  
- **P4 (NON-URGENT):** Conditions not expected to deteriorate, can wait 1-2 hours
  - Care Location: `"Clinique sans rendez-vous"`
  
- **P5 (SELF-CARE):** May not require physician intervention, appropriate for clinic or self-care
  - Care Location: `"Clinique avec rendez-vous ou t√©l√©m√©decine"`

**Output Includes:**
- `triage_level`: EMERGENCY/URGENT/SEMI-URGENT/NON-URGENT/SELF-CARE
- `urgency_score`: 1-10 (where 10 is most urgent)
- `reasoning`: Brief medical reasoning
- `recommended_action`: Specific next steps
- `hpi_summary`: French confirmation summary (see Step 3)
- `follow_up_questions`: Array of 10 specific questions
- `sap_note`: Super Spartan SAP format (S: Subjective, A: Assessment, P: Plan)
- `medications`: Array with dosages, quantities, instructions
- `lab_work`: List of specific lab tests needed
- `imaging`: Array of imaging studies with indications and timing
- `referrals`: Array of specialist referrals
- `work_leave`: Work leave certificate
- `workplace_modifications`: Workplace restrictions
- `insurance_documentation`: Complete insurance documentation with ICD codes
- `telemedicine_limitations`: Explanation of telemedicine limitations
- `emergency_referral`: Emergency department referral with triage level

---

### **STEP 3: HPI Confirmation Summary Generated**
**Format:** Exact French medical template

**Template:**
```
"Juste pour confirmer avec vous avant de continuer; vous √™tes un(e) [gender] de [age] ans pr√©sentant [chief_complaint]. [detailed_symptoms]. [location]. [severity]. [chronic_conditions]. [medication_allergies]. Est-ce que ce r√©sum√© est exact ?"
```

**Display:** Shows in blue confirmation box  
**Patient Action:** Can confirm (YES/NO) or provide corrections

**Location:** `PatientIntakeForm.tsx` lines 265-315

---

### **STEP 4: 10 Follow-Up Questions Presented**
**Source:** Generated by AI based on patient's specific symptoms

**Format:** 
- Exactly 10 questions
- Contextual to patient's condition
- Displayed in green highlighted box
- Each question has a textarea for patient response

**Example Questions:**
1. "Avez-vous des douleurs thoraciques ou des difficult√©s respiratoires?"
2. "Avez-vous eu de la fi√®vre dans les derni√®res 24 heures?"
3. "Vos sympt√¥mes vous r√©veillent-ils la nuit?"
4. "Avez-vous voyag√© r√©cemment?"
5. "Prenez-vous des m√©dicaments actuellement?"
6. "Avez-vous des ant√©c√©dents familiaux pertinents?"
7. "Votre app√©tit a-t-il chang√©?"
8. "Avez-vous perdu du poids r√©cemment?"
9. "Avez-vous eu des √©tourdissements ou des pertes de conscience?"
10. "Y a-t-il quelque chose d'autre que vous aimeriez mentionner?"

**Storage:** Answers saved to `patient_answers` table as JSON:
```json
{
  "0": "answer to question 1",
  "1": "answer to question 2",
  ...
  "9": "answer to question 10"
}
```

**Location:** `PatientIntakeForm.tsx` lines 279-303

---

### **STEP 5: Patient Answers Questions**
**Handler:** `handleAnswerChange()` function  
**Storage:** `patientAnswers` state object

**Process:**
- Patient types answers in textareas
- Answers saved to state in real-time
- Can be saved to database via `savePatientAnswers()` function

**Database:** `patient_answers` table:
- `patient_id`: De-identified ID
- `answers`: JSONB with all 10 answers
- `hpi_confirmed`: Boolean (true/false/null)
- `hpi_corrections`: Text corrections if patient disagreed
- `created_at`: Timestamp

---

### **STEP 6: Enhanced SOAP Note Generation**
**API:** `/api/generate-enhanced-soap`  
**Trigger:** Patient clicks "Save Answers" or submits corrections

**Input:**
- Original HPI summary
- Patient answers (all 10)
- Triage result
- HPI corrections (if any)

**Output:**
- `enhanced_soap_note`: Complete SOAP note combining HPI + Q&A
- `doctor_hpi_summary`: Comprehensive version for physician

**Location:** `PatientIntakeForm.tsx` lines 84-128

---

### **STEP 7: Comprehensive Report Display**
**Contains All 12 Sections:**

1. **HPI_SUMMARY** - Patient confirmation summary (French)
2. **FOLLOW_UP_QUESTIONS** - 10 questions with patient answers
3. **SAP_NOTE** - Super Spartan format (S: / A: / P:)
4. **MEDICATIONS** - Specific medications with dosages
5. **LAB_WORK** - Lab tests needed
6. **IMAGING** - Imaging studies with indications
7. **REFERRALS** - Specialist referrals with timing
8. **WORK_LEAVE** - Work leave certificate
9. **WORKPLACE_MODIFICATIONS** - Workplace restrictions
10. **INSURANCE_DOCUMENTATION** - Insurance docs with ICD codes
11. **TELEMEDICINE_LIMITATIONS** - Telemedicine limitations explanation
12. **EMERGENCY_REFERRAL** - Emergency department referral

**Display:** Organized sections with patient ID, triage level, and care location

---

### **STEP 8: Triage Level Display**
**Visual Indicators:**
- **P1:** Red badge - "911 (Transport en ambulance requis)"
- **P2:** Orange badge - "Urgence hospitali√®re"
- **P3:** Yellow badge - "Urgence hospitali√®re ou urgence mineure"
- **P4:** Green badge - "Clinique sans rendez-vous"
- **P5:** Blue badge - "Clinique avec rendez-vous ou t√©l√©m√©decine"

**Includes:**
- Urgency score (1-10)
- Reasoning for triage level
- Recommended action
- Where to consult message

**Location:** `PatientIntakeForm.tsx` lines 251-263

---

### **STEP 9: Printable Document Generation**
**Function:** `generateSubjectivePrintable()`  
**API:** `/api/patient-hpi-print`

**Output:** Print-optimized HTML document containing:
- Patient ID (prominently displayed)
- Complete medical summary
- All 10 questions with patient answers
- Triage level and care location
- Instructions for emergency department

**Features:**
- Print button (`window.print()`)
- Print-optimized CSS
- Professional medical format
- French language

**Location:** `PatientIntakeForm.tsx` lines 48-82, 316-380

---

### **STEP 10: Database Storage**
**Tables Used:**

1. **`consultations` table:**
   - `patient_id`: De-identified ID
   - `form_data`: Full form submission (JSONB)
   - `chief_complaint`: Text
   - `triage_level`: P1-P5
   - `created_at`: Timestamp

2. **`patient_answers` table:**
   - `patient_id`: De-identified ID
   - `answers`: JSONB with all 10 Q&A responses
   - `hpi_confirmed`: Boolean
   - `hpi_corrections`: Text
   - `created_at`: Timestamp

3. **`comprehensive_reports` table:**
   - `patient_id`: De-identified ID
   - `report_data`: JSONB with all 12 sections
   - `created_at`: Timestamp

4. **`medical_reports` table (for doctor):**
   - `patient_id`: De-identified ID
   - `report_data`: JSONB (all 12 sections)
   - `generated_at`: Timestamp
   - `report_type`: VARCHAR(50)

**Location:** `PatientIntakeForm.tsx` lines 130-151

---

## üì± ALL PATIENT FUNCTIONALITIES

### **1. Patient Authentication**
- **Google OAuth Login**
- **Location:** `client/src/pages/patient-login.tsx`
- **Redirect:** Patient dashboard after login

### **2. Patient Intake Form**
**Two Versions Available:**

**A. Enhanced Patient Intake Form**
- **Location:** `client/src/components/patient/EnhancedPatientIntakeForm.tsx`
- **Features:** Multi-step wizard (5 steps)
- **Steps:**
  1. Basic Information
  2. Medical History
  3. Current Symptoms
  4. Treatment History
  5. Additional Info

**B. Standard Patient Intake Form**
- **Location:** `client/src/components/patient/PatientIntakeForm.tsx`
- **Features:** Single-page comprehensive form
- **All fields in one view**

### **3. Public Patient Intake**
- **Location:** `client/src/pages/public-patient-intake.tsx`
- **Features:** 
  - No login required
  - Google Translate integration
  - Multi-language support
  - Hero image display

### **4. Patient Dashboard**
- **Location:** `client/src/pages/patient-dashboard.tsx`
- **Features:**
  - View previous consultations
  - Access printable documents
  - Review triage levels

### **5. HPI Confirmation System**
- **Features:**
  - AI-generated French summary
  - Confirmation radio buttons (YES/NO)
  - Correction text field
  - Real-time validation

### **6. Interactive Q&A System**
- **Features:**
  - 10 AI-generated questions
  - Textarea inputs for each answer
  - Save functionality
  - Database persistence

### **7. Triage Level Display**
- **Features:**
  - Color-coded badges (P1-P5)
  - Urgency score (1-10)
  - Care location instructions
  - Visual priority indicators

### **8. Enhanced SOAP Note**
- **Features:**
  - Combines HPI + patient answers
  - Professional medical format
  - Doctor-ready summary
  - French language

### **9. Printable Medical Document**
- **Features:**
  - Print-optimized layout
  - Complete medical summary
  - All Q&A included
  - Emergency department ready
  - Print button functionality

### **10. Patient ID Generation**
- **Format:** 10-character alphanumeric (e.g., `A1B2C3D4E5`)
- **Pattern:** Letter+Digit pairs √ó 5
- **Usage:** All database lookups

### **11. Multi-Language Support**
- **Languages:** English and French
- **Features:**
  - Google Translate integration
  - French medical templates
  - Bilingual UI elements

### **12. Form Validation**
- **Features:**
  - Required field checking
  - Patient ID format validation
  - Medical data sanitization
  - API error handling

---

## üîó API ENDPOINTS USED

### **Patient-Facing APIs:**

1. **`POST /api/comprehensive-triage`**
   - **Input:** Complete patient form data
   - **Output:** Triage result with all 12 sections
   - **Purpose:** Initial triage processing

2. **`POST /api/generate-enhanced-soap`**
   - **Input:** HPI summary + patient answers
   - **Output:** Enhanced SOAP note
   - **Purpose:** Combine HPI with Q&A

3. **`POST /api/patient-hpi-print`**
   - **Input:** Patient ID + HPI data
   - **Output:** Print-optimized HTML
   - **Purpose:** Generate printable document

4. **`GET /api/assets/images`**
   - **Output:** Available hero images
   - **Purpose:** Display images on intake page

---

## üìä DATA FLOW DIAGRAM

```
PATIENT FORM SUBMISSION
    ‚Üì
/api/comprehensive-triage
    ‚Üì
AI PROCESSING (OpenAI/Claude)
    ‚Üì
TRIAGE RESULT (P1-P5 + 12 sections)
    ‚Üì
HPI CONFIRMATION DISPLAY
    ‚Üì
10 FOLLOW-UP QUESTIONS
    ‚Üì
PATIENT ANSWERS QUESTIONS
    ‚Üì
SAVE TO patient_answers TABLE
    ‚Üì
/api/generate-enhanced-soap
    ‚Üì
ENHANCED SOAP NOTE GENERATED
    ‚Üì
SAVE TO comprehensive_reports TABLE
    ‚Üì
PRINTABLE DOCUMENT GENERATED
    ‚Üì
DOCTOR CAN ACCESS VIA PATIENT ID
```

---

## üéØ KEY FEATURES SUMMARY

### **What Patients Can Do:**
1. ‚úÖ Fill comprehensive medical intake form
2. ‚úÖ Receive AI-generated HPI confirmation summary
3. ‚úÖ Confirm or correct medical summary
4. ‚úÖ Answer 10 follow-up questions
5. ‚úÖ View triage level (P1-P5) with care location
6. ‚úÖ See urgency score (1-10)
7. ‚úÖ Generate enhanced SOAP note
8. ‚úÖ Print professional medical document
9. ‚úÖ Access patient dashboard
10. ‚úÖ View previous consultations
11. ‚úÖ Use multi-language support (EN/FR)

### **What the System Does:**
1. ‚úÖ Generates de-identified patient ID
2. ‚úÖ Processes symptoms through AI triage
3. ‚úÖ Assigns CTAS triage level (P1-P5)
4. ‚úÖ Creates French medical summaries
5. ‚úÖ Generates contextual follow-up questions
6. ‚úÖ Stores all data in Supabase database
7. ‚úÖ Creates 12-section comprehensive report
8. ‚úÖ Provides print-ready medical documents
9. ‚úÖ Enables doctor access via patient ID

---

## üìù TECHNICAL IMPLEMENTATION

### **Frontend Components:**
- `PatientIntakeForm.tsx` - Main patient form
- `EnhancedPatientIntakeForm.tsx` - Multi-step wizard
- `public-patient-intake.tsx` - Public access page
- `patient-dashboard.tsx` - Patient portal

### **Backend Functions:**
- `comprehensive-triage.js` - Triage processing
- `generate-enhanced-soap.js` - SOAP generation
- `patient-hpi-print.js` - Print document generation

### **Database Tables:**
- `consultations` - Patient form submissions
- `patient_answers` - Q&A responses
- `comprehensive_reports` - Full medical reports
- `medical_reports` - Doctor-accessible reports

### **AI Integration:**
- **OpenAI GPT-4o** - Primary medical AI
- **Anthropic Claude** - Alternative AI provider
- **Prompts:** CTAS-based triage templates
- **Language:** French medical terminology

---

## ‚úÖ STATUS: FULLY OPERATIONAL

All patient functionalities are **implemented and working** in production at `https://instanthpi.ca`

**Last Updated:** January 8, 2025  
**Status:** ‚úÖ Production Ready

