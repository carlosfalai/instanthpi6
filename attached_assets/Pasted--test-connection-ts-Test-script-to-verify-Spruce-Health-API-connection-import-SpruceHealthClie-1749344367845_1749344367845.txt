// test-connection.ts - Test script to verify Spruce Health API connection
import { SpruceHealthClient } from './src/spruce-health-client';
import dotenv from 'dotenv';

dotenv.config();

async function testSpruceConnection() {
  console.log('ğŸ”§ Testing Spruce Health API Connection...\n');
  
  // Check if credentials are provided
  const bearerToken = process.env.SPRUCE_BEARER_TOKEN;
  const accessId = process.env.SPRUCE_ACCESS_ID;
  
  if (!bearerToken) {
    console.error('âŒ SPRUCE_BEARER_TOKEN not found in environment variables');
    process.exit(1);
  }
  
  console.log('âœ… Bearer Token:', bearerToken.substring(0, 20) + '...');
  console.log('âœ… Access ID:', accessId || 'Not provided');
  console.log('');
  
  // Initialize client
  const client = new SpruceHealthClient({
    bearerToken: bearerToken
  });
  
  try {
    console.log('ğŸ” Testing API connection...');
    
    // Test 1: Get conversations
    console.log('\nğŸ“‹ Test 1: Fetching conversations...');
    const conversations = await client.getConversations({ per_page: 5 });
    console.log(`âœ… Success! Found ${conversations.conversations.length} conversations`);
    console.log(`ğŸ“Š Total conversations: ${conversations.pagination.total}`);
    
    if (conversations.conversations.length > 0) {
      const firstConv = conversations.conversations[0];
      console.log(`ğŸ“ First conversation: "${firstConv.subject}" (${firstConv.status})`);
      console.log(`ğŸ‘¥ Participants: ${firstConv.participants.map(p => p.name).join(', ')}`);
      
      // Test 2: Get messages from first conversation
      console.log('\nğŸ’¬ Test 2: Fetching messages from first conversation...');
      try {
        const messages = await client.getMessages(firstConv.id, { per_page: 3 });
        console.log(`âœ… Success! Found ${messages.messages.length} messages`);
        
        if (messages.messages.length > 0) {
          const firstMessage = messages.messages[0];
          console.log(`ğŸ“ Latest message from: ${firstMessage.sender_name}`);
          console.log(`ğŸ“… Sent at: ${firstMessage.sent_at}`);
          console.log(`ğŸ’­ Content preview: ${firstMessage.content.substring(0, 50)}...`);
        }
      } catch (msgError) {
        console.log(`âš ï¸  Could not fetch messages: ${msgError}`);
      }
    }
    
    // Test 3: Check rate limit status
    console.log('\nâ±ï¸  Test 3: Checking rate limit status...');
    const rateLimitStatus = client.getRateLimitStatus();
    console.log(`âœ… Rate limit remaining: ${rateLimitStatus.remaining}/60`);
    console.log(`ğŸ”„ Reset time: ${rateLimitStatus.resetTime.toISOString()}`);
    
    // Test 4: Search functionality
    console.log('\nğŸ” Test 4: Testing search functionality...');
    try {
      const searchResults = await client.searchConversations('patient');
      console.log(`âœ… Search completed! Found ${searchResults.length} results`);
    } catch (searchError) {
      console.log(`âš ï¸  Search test failed: ${searchError}`);
    }
    
    console.log('\nğŸ‰ All tests completed successfully!');
    console.log('ğŸš€ Your Spruce Health integration is ready to use!');
    
  } catch (error) {
    console.error('\nâŒ API connection failed:');
    console.error('Error:', error);
    
    if (error.message.includes('401')) {
      console.error('\nğŸ”‘ Authentication Issue:');
      console.error('- Check that your bearer token is correct');
      console.error('- Verify your Spruce Health account has API access');
      console.error('- Contact Spruce Health support if the token should be valid');
    } else if (error.message.includes('403')) {
      console.error('\nğŸš« Permission Issue:');
      console.error('- Your account may not have API access enabled');
      console.error('- Contact Spruce Health to request API access');
    } else if (error.message.includes('404')) {
      console.error('\nğŸ” Endpoint Issue:');
      console.error('- The API endpoint may have changed');
      console.error('- Check Spruce Health API documentation for updates');
    } else if (error.message.includes('429')) {
      console.error('\nâ° Rate Limit Issue:');
      console.error('- You have exceeded the API rate limit');
      console.error('- Wait a few minutes and try again');
    } else {
      console.error('\nğŸŒ Network Issue:');
      console.error('- Check your internet connection');
      console.error('- Verify Spruce Health API is accessible');
    }
    
    process.exit(1);
  }
}

// Run the test
if (require.main === module) {
  testSpruceConnection().catch(console.error);
}

export default testSpruceConnection;